<!DOCTYPE html>
<html>
<head>
  <title>Voice-Controlled Bulb/Socket</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h2>Voice-Based Control: Bulbs & Sockets</h2>
  <div id="status">Connecting to MQTT...</div><br>

  <button onclick="startListening()">üé§ Speak Command</button><br><br>
  <div id="transcript">You said: ...</div>

  <hr>
  <h3>Manual Control</h3>
  <button onclick="send(1, 'ON')">Bulb 1 ON</button>
  <button onclick="send(1, 'OFF')">Bulb 1 OFF</button><br><br>

  <button onclick="send(2, 'ON')">Bulb 2 ON</button>
  <button onclick="send(2, 'OFF')">Bulb 2 OFF</button><br><br>

  <button onclick="send(3, 'ON')">Socket 1 ON</button>
  <button onclick="send(3, 'OFF')">Socket 1 OFF</button><br><br>

  <button onclick="send(4, 'ON')">Socket 2 ON</button>
  <button onclick="send(4, 'OFF')">Socket 2 OFF</button>

  <script>
    // MQTT setup
    const client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt");
    const topicBase = "lucifer123/home/relay";

    client.on('connect', () => {
      document.getElementById("status").innerText = "‚úÖ Connected to test.mosquitto.org";
    });

    client.on('error', () => {
      document.getElementById("status").innerText = "‚ùå MQTT connection error!";
    });

    function send(relay, state) {
      const topic = `${topicBase}${relay}`;
      client.publish(topic, state);
    }

    // Speech recognition
    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech recognition not supported in this browser.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.start();

      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript.toLowerCase();
        document.getElementById("transcript").innerText = "You said: " + text;
        parseNaturalCommand(text);
      };

      recognition.onerror = function(event) {
        document.getElementById("transcript").innerText = "‚ùå Error: " + event.error;
      };
    }

    // Command parser for natural language
    function parseNaturalCommand(text) {
      const relays = {
        "first bulb": 1,
        "second bulb": 2,
        "first socket": 3,
        "second socket": 4
      };

      let matchedDevice = null;
      let action = null;

      for (const phrase in relays) {
        if (text.includes(phrase)) {
          matchedDevice = relays[phrase];
          break;
        }
      }

      if (text.includes("power on")) action = "ON";
      else if (text.includes("power off")) action = "OFF";

      if (matchedDevice && action) {
        send(matchedDevice, action);
      } else {
        document.getElementById("transcript").innerText += "\n‚ùå Could not understand command.";
      }
    }
  </script>
</body>
</html>

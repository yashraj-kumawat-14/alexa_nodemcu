<!DOCTYPE html>
<html>
<head>
  <title>Smart Voice Control (Fuzzy)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h2>Voice Control: Bulbs & Sockets (Smart Parser)</h2>
  <div id="status">Connecting to MQTT...</div><br>

  <button onclick="startListening()">üé§ Speak</button><br><br>
  <div id="transcript">You said: ...</div>

  <script>
    const client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt");
    const topicBase = "lucifer123/home/relay";

    client.on('connect', () => {
      document.getElementById("status").innerText = "‚úÖ Connected to MQTT broker";
    });

    client.on('error', () => {
      document.getElementById("status").innerText = "‚ùå MQTT error";
    });

    function send(relay, state) {
      const topic = `${topicBase}${relay}`;
      client.publish(topic, state);
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return alert("Speech recognition not supported.");

      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.start();

      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript.toLowerCase();
        document.getElementById("transcript").innerText = "You said: " + text;
        parseFuzzyCommand(text);
      };

      recognition.onerror = function(event) {
        document.getElementById("transcript").innerText = "‚ùå Error: " + event.error;
      };
    }

    function parseFuzzyCommand(text) {
      const deviceMap = [
        { keywords: ["first bulb", "bulb one", "blub 1", "1st bulb"], relay: 1 },
        { keywords: ["second bulb", "bulb two", "blub 2", "2nd bulb"], relay: 2 },
        { keywords: ["first socket", "socket one", "soket 1", "1st socket"], relay: 3 },
        { keywords: ["second socket", "socket two", "soket 2", "2nd socket"], relay: 4 }
      ];

      const actions = [
        { keywords: ["power on", "turn on", "switch on", "on"], state: "ON" },
        { keywords: ["power off", "turn off", "switch off", "off"], state: "OFF" }
      ];

      let matchedDevice = null;
      let matchedAction = null;

      for (let d of deviceMap) {
        for (let phrase of d.keywords) {
          if (text.includes(phrase)) {
            matchedDevice = d.relay;
            break;
          }
        }
        if (matchedDevice) break;
      }

      for (let a of actions) {
        for (let phrase of a.keywords) {
          if (text.includes(phrase)) {
            matchedAction = a.state;
            break;
          }
        }
        if (matchedAction) break;
      }

      if (matchedDevice && matchedAction) {
        send(matchedDevice, matchedAction);
        document.getElementById("transcript").innerText += `\n‚úÖ Sending ${matchedAction} to relay ${matchedDevice}`;
      } else {
        document.getElementById("transcript").innerText += "\n‚ùå Didn't fully understand command.";
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Smart Control (Voice + Buttons)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
    }
    #transcript {
      font-size: 18px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Bulb & Socket Control</h2>
  <div id="status">Connecting to MQTT...</div><br>

  <button onclick="startListening()">üé§ Speak Command</button>
  <div id="transcript">You said: ...</div>

  <hr>
  <h3>Manual Control</h3>
  <div>
    <button onclick="send(1, 'ON')">üîÜ Bulb 1 ON</button>
    <button onclick="send(1, 'OFF')">üï≥ Bulb 1 OFF</button><br>
    <button onclick="send(2, 'ON')">üîÜ Bulb 2 ON</button>
    <button onclick="send(2, 'OFF')">üï≥ Bulb 2 OFF</button><br>
    <button onclick="send(3, 'ON')">üîå Socket 1 ON</button>
    <button onclick="send(3, 'OFF')">üîå Socket 1 OFF</button><br>
    <button onclick="send(4, 'ON')">üîå Socket 2 ON</button>
    <button onclick="send(4, 'OFF')">üîå Socket 2 OFF</button>
  </div>

  <script>
    const client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt");
    const topicBase = "lucifer123/home/relay";

    client.on('connect', () => {
      document.getElementById("status").innerText = "‚úÖ Connected to MQTT broker";
    });

    client.on('error', () => {
      document.getElementById("status").innerText = "‚ùå MQTT connection error";
    });

    function send(relay, state) {
      const topic = `${topicBase}${relay}`;
      client.publish(topic, state);
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech recognition not supported in this browser.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.start();

      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript.toLowerCase();
        document.getElementById("transcript").innerText = "üó£ You said: " + text;
        parseFuzzyCommand(text);
      };

      recognition.onerror = function(event) {
        document.getElementById("transcript").innerText = "‚ùå Error: " + event.error;
      };
    }

    function parseFuzzyCommand(text) {
      const deviceMap = [
        { keywords: ["first bulb", "bulb one", "blub 1", "1st bulb"], relay: 1 },
        { keywords: ["second bulb", "bulb two", "blub 2", "2nd bulb"], relay: 2 },
        { keywords: ["first socket", "socket one", "soket 1", "1st socket"], relay: 3 },
        { keywords: ["second socket", "socket two", "soket 2", "2nd socket"], relay: 4 }
      ];

      const actions = [
        { keywords: ["power on", "turn on", "switch on", "on"], state: "ON" },
        { keywords: ["power off", "turn off", "switch off", "off"], state: "OFF" }
      ];

      let matchedDevice = null;
      let matchedAction = null;

      for (let d of deviceMap) {
        for (let phrase of d.keywords) {
          if (text.includes(phrase)) {
            matchedDevice = d.relay;
            break;
          }
        }
        if (matchedDevice) break;
      }

      for (let a of actions) {
        for (let phrase of a.keywords) {
          if (text.includes(phrase)) {
            matchedAction = a.state;
            break;
          }
        }
        if (matchedAction) break;
      }

      if (matchedDevice && matchedAction) {
        send(matchedDevice, matchedAction);
        document.getElementById("transcript").innerText += `\n‚úÖ ${matchedAction} ‚Üí Relay ${matchedDevice}`;
      } else {
        document.getElementById("transcript").innerText += "\n‚ùå Could not understand.";
      }
    }
  </script>
</body>
</html>
